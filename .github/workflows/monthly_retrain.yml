name: Monthly Retrain

on:
  schedule:
    - cron: "0 2 28 * *"   # 28th of every month at 2:00 AM UTC
  workflow_dispatch:         # Allow manual trigger from GitHub UI
    inputs:
      evaluate_only:
        description: "Only evaluate models, skip retraining (good for testing)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  retrain:
    name: Monthly Model Retrain
    runs-on: ubuntu-latest
    timeout-minutes: 120    # Retraining can take time

    env:
      # --- Secrets (sensitive) ---
      DATABASE_URL:    ${{ secrets.DATABASE_URL }}
      GROQ_API_KEY:    ${{ secrets.GROQ_API_KEY }}

      # --- Variables (non-sensitive config) ---
      MODEL_DIR:       ${{ vars.MODEL_DIR }}
      DATA_FILE:       ${{ vars.DATA_FILE }}
      MIN_NEW_ROWS:    ${{ vars.MIN_NEW_ROWS }}
      RETRAIN_DAY:     ${{ vars.RETRAIN_DAY }}
      RETRAIN_HOUR:    ${{ vars.RETRAIN_HOUR }}
      RETRAIN_MINUTE:  ${{ vars.RETRAIN_MINUTE }}
      LLM_BACKEND:     ${{ vars.LLM_BACKEND }}
      GROQ_MODEL:      ${{ vars.GROQ_MODEL }}

    steps:
      # ------------------------------------------------------------------ #
      # 1. Checkout repo
      # ------------------------------------------------------------------ #
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------------ #
      # 2. Set up Python 3.11
      # ------------------------------------------------------------------ #
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # ------------------------------------------------------------------ #
      # 3. Install dependencies
      # ------------------------------------------------------------------ #
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      # ------------------------------------------------------------------ #
      # 4. Run retrain or evaluate-only
      # ------------------------------------------------------------------ #
      - name: Run retrain scheduler
        run: |
          if [ "${{ github.event.inputs.evaluate_only }}" == "true" ]; then
            echo "Running in evaluate-only mode..."
            python retrain_scheduler.py --evaluate-only
          else
            echo "Running full retrain with accumulated data..."
            python retrain_scheduler.py --run-now
          fi

      # ------------------------------------------------------------------ #
      # 5. Commit updated retrain_history.csv back to repo
      # ------------------------------------------------------------------ #
      - name: Commit retrain history
        if: success()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add saved_models/retrain_history.csv || true
          git diff --cached --quiet || git commit -m "chore: update retrain history [$(date -u '+%Y-%m-%d')]"
          git push || echo "Nothing to push"

      # ------------------------------------------------------------------ #
      # 6. Upload retrain artifacts (logs + model files)
      # ------------------------------------------------------------------ #
      - name: Upload retrain artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: retrain-results-${{ github.run_id }}
          path: |
            saved_models/retrain_history.csv
            saved_models/*.keras
            saved_models/*.pkl
            logs/
          retention-days: 30

      # ------------------------------------------------------------------ #
      # 7. Notify on failure
      # ------------------------------------------------------------------ #
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Monthly retrain FAILED on $(date -u '+%Y-%m-%d %H:%M UTC')"